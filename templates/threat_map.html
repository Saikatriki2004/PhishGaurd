<!DOCTYPE html>
<html lang="en">
<!--
  NAVIGATION AUTHORITY (GAP 4):
  - All navigation uses full-page reloads (Flask routing)
  - State is not preserved between pages
  - Active tab derived from URL path only
  - Missing routes fallback to dashboard
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhishGuard - Threat Map</title>
    <meta name="description" content="Real-time global threat visualization map">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0f1a;
            min-height: 100vh;
            color: #e2e8f0;
            overflow: hidden;
        }

        /* ============ NAVBAR ============ */
        .navbar {
            background: #111827;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #1f2937;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.125rem;
            color: #fff;
            text-decoration: none;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        .nav-search {
            display: flex;
            align-items: center;
            background: #1f2937;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            gap: 0.5rem;
            min-width: 260px;
        }

        .nav-search svg {
            width: 16px;
            height: 16px;
            color: #6b7280;
        }

        .nav-search input {
            border: none;
            background: transparent;
            font-size: 0.875rem;
            color: #e2e8f0;
            outline: none;
            width: 100%;
        }

        .nav-search input::placeholder {
            color: #6b7280;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #9ca3af;
            font-weight: 500;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: #fff;
        }

        .nav-links a.active {
            color: #fff;
            font-weight: 600;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: #1f2937;
            transition: background 0.2s;
        }

        .nav-icon:hover {
            background: #374151;
        }

        .nav-icon svg {
            width: 18px;
            height: 18px;
            color: #9ca3af;
        }

        .avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .avatar svg {
            width: 18px;
            height: 18px;
            color: white;
        }

        /* ============ MAIN LAYOUT ============ */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }

        /* ============ LEFT SIDEBAR ============ */
        .left-sidebar {
            width: 280px;
            background: #111827;
            border-right: 1px solid #1f2937;
            padding: 1.25rem;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .sidebar-header svg {
            width: 18px;
            height: 18px;
            color: #3b82f6;
        }

        .sidebar-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #fff;
        }

        .sidebar-subtitle {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.125rem;
        }

        .section-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 1.25rem 0 0.75rem;
        }

        .focus-search {
            display: flex;
            align-items: center;
            background: #1f2937;
            border-radius: 8px;
            padding: 0.625rem 0.875rem;
            gap: 0.5rem;
        }

        .focus-search svg {
            width: 16px;
            height: 16px;
            color: #6b7280;
        }

        .focus-search input {
            border: none;
            background: transparent;
            font-size: 0.875rem;
            color: #e2e8f0;
            outline: none;
            width: 100%;
        }

        .focus-search input::placeholder {
            color: #6b7280;
        }

        .threat-types {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
            cursor: pointer;
        }

        .checkbox-item label {
            font-size: 0.875rem;
            color: #e2e8f0;
            cursor: pointer;
        }

        .reset-link {
            font-size: 0.75rem;
            color: #3b82f6;
            text-decoration: none;
            margin-left: auto;
        }

        .reset-link:hover {
            text-decoration: underline;
        }

        .attack-vectors {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .vector-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #374151;
            background: transparent;
            color: #9ca3af;
            transition: all 0.2s;
        }

        .vector-btn:hover {
            border-color: #4b5563;
            color: #e2e8f0;
        }

        .vector-btn.active {
            background: #1d4ed8;
            border-color: #1d4ed8;
            color: #fff;
        }

        .vector-btn svg {
            width: 14px;
            height: 14px;
        }

        .display-modes {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #1f2937;
            background: transparent;
            transition: all 0.2s;
        }

        .mode-option:hover {
            border-color: #374151;
        }

        .mode-option.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .mode-option input {
            display: none;
        }

        .mode-radio {
            width: 18px;
            height: 18px;
            border: 2px solid #4b5563;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-option.active .mode-radio {
            border-color: #3b82f6;
        }

        .mode-option.active .mode-radio::after {
            content: '';
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
        }

        .mode-info {
            flex: 1;
        }

        .mode-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .mode-desc {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .mode-icon {
            color: #6b7280;
        }

        .mode-icon svg {
            width: 18px;
            height: 18px;
        }

        .legend-box {
            background: #1f2937;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .legend-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .legend-header svg {
            width: 14px;
            height: 14px;
            color: #6b7280;
        }

        .legend-header span {
            font-size: 0.8rem;
            font-weight: 600;
            color: #e2e8f0;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.critical {
            background: #ef4444;
        }

        .legend-dot.suspicious {
            background: #f59e0b;
        }

        .legend-dot.safe {
            background: #3b82f6;
        }

        .legend-item span {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .map-indicators {
            margin-top: 1rem;
        }

        .indicator-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.375rem;
        }

        .indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }

        .indicator-line {
            width: 20px;
            height: 2px;
            border-top: 2px dashed #ef4444;
        }

        .indicator-gradient {
            width: 40px;
            height: 6px;
            background: linear-gradient(90deg, #1d4ed8, #3b82f6, #60a5fa);
            border-radius: 2px;
        }

        .indicator-item span {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        /* ============ MAP CONTAINER ============ */
        .map-container {
            flex: 1;
            position: relative;
            background: #0a0f1a;
        }

        #threat-map {
            width: 100%;
            height: 100%;
            background: #0a0f1a;
        }

        .leaflet-container {
            background: #0a0f1a;
        }

        .zoom-controls {
            position: absolute;
            right: 1rem;
            bottom: 5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            z-index: 500;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #e2e8f0;
            font-size: 1.25rem;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: #374151;
        }

        .locate-btn {
            width: 36px;
            height: 36px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .locate-btn svg {
            width: 18px;
            height: 18px;
            color: #9ca3af;
        }

        .locate-btn:hover {
            background: #374151;
        }

        /* ============ RIGHT SIDEBAR ============ */
        .right-sidebar {
            width: 300px;
            background: #111827;
            border-left: 1px solid #1f2937;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .live-feed {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .feed-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .feed-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feed-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .feed-title span {
            font-weight: 600;
            font-size: 0.9rem;
            color: #fff;
        }

        .feed-badge {
            font-size: 0.65rem;
            font-weight: 600;
            color: #6b7280;
            background: #1f2937;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .feed-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .feed-item {
            padding: 0.75rem;
            background: #1f2937;
            border-radius: 8px;
            border-left: 3px solid #ef4444;
        }

        .feed-item.suspicious {
            border-left-color: #f59e0b;
        }

        .feed-item.safe {
            border-left-color: #3b82f6;
        }

        .feed-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.375rem;
        }

        .feed-item-type {
            font-size: 0.8rem;
            font-weight: 600;
            color: #ef4444;
        }

        .feed-item.suspicious .feed-item-type {
            color: #f59e0b;
        }

        .feed-item.safe .feed-item-type {
            color: #3b82f6;
        }

        .feed-item-time {
            font-size: 0.7rem;
            color: #6b7280;
        }

        .feed-item-entity {
            font-size: 0.8rem;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }

        .feed-item-location {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            color: #6b7280;
        }

        .feed-item-location svg {
            width: 12px;
            height: 12px;
        }

        .top-regions {
            padding: 1rem;
            border-top: 1px solid #1f2937;
        }

        .regions-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .region-items {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .region-item {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .region-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .region-name {
            font-size: 0.8rem;
            color: #e2e8f0;
        }

        .region-count {
            font-size: 0.8rem;
            font-weight: 600;
            color: #ef4444;
        }

        .region-bar {
            height: 4px;
            background: #1f2937;
            border-radius: 2px;
            overflow: hidden;
        }

        .region-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease-out;
        }

        .region-bar-fill.critical {
            background: #ef4444;
        }

        .region-bar-fill.warning {
            background: #f59e0b;
        }

        .region-bar-fill.info {
            background: #3b82f6;
        }

        /* ============ BOTTOM CONTROLS ============ */
        .bottom-controls {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(17, 24, 39, 0.9);
            padding: 0.625rem 1.25rem;
            border-radius: 30px;
            border: 1px solid #374151;
            z-index: 500;
        }

        .control-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #9ca3af;
            transition: all 0.2s;
        }

        .control-btn:hover {
            color: #fff;
            background: #374151;
        }

        .control-btn svg {
            width: 18px;
            height: 18px;
        }

        .timeline-visual {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 24px;
        }

        .timeline-bar {
            width: 4px;
            background: #3b82f6;
            border-radius: 2px;
            transition: height 0.3s;
        }

        .live-badge {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 0.25rem 0.625rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Custom marker styles */
        .threat-marker {
            position: relative;
        }

        .threat-marker-inner {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: markerPulse 2s infinite;
        }

        .threat-marker-inner.critical {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        .threat-marker-inner.suspicious {
            background: #f59e0b;
            box-shadow: 0 0 10px #f59e0b;
        }

        .threat-marker-inner.safe {
            background: #3b82f6;
            box-shadow: 0 0 10px #3b82f6;
        }

        @keyframes markerPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }
        }

        /* Attack vector line animation */
        .attack-vector-path {
            stroke-dasharray: 10, 5;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -15;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">
            <a href="/dashboard" class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                    </svg>
                </div>
                PhishGuard
            </a>
            <div class="nav-search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                </svg>
                <input type="text" placeholder="Search IP, Domain, or Hash" id="globalSearch">
            </div>
        </div>

        <div class="nav-links">
            <a href="/dashboard">Dashboard</a>
            <a href="/threat-map" class="active">Map</a>
            <a href="/scan-history">Scan History</a>
            <a href="/settings">Settings</a>
        </div>

        <div class="nav-right">
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                    <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                </svg>
            </div>
            <div class="nav-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
            </div>
            <div class="avatar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                </svg>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <aside class="left-sidebar">
            <div class="sidebar-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3" />
                    <path d="M12 1v6m0 6v10M1 12h6m6 0h10" />
                </svg>
                <div>
                    <div class="sidebar-title">Map Controls</div>
                    <div class="sidebar-subtitle">Configure threat visualization layers</div>
                </div>
            </div>

            <div class="section-label">Focus Region</div>
            <div class="focus-search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                </svg>
                <input type="text" placeholder="E.g. Eastern Europe" id="regionSearch">
            </div>

            <div class="section-label" style="display: flex; align-items: center;">
                Threat Types
                <a href="#" class="reset-link" id="resetFilters">Reset</a>
            </div>
            <div class="threat-types">
                <div class="checkbox-item">
                    <input type="checkbox" id="malware" checked>
                    <label for="malware">Malware & Ransomware</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="credential" checked>
                    <label for="credential">Credential Harvesting</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="social">
                    <label for="social">Social Engineering</label>
                </div>
            </div>

            <div class="section-label">Attack Vector</div>
            <div class="attack-vectors">
                <button class="vector-btn active" data-vector="email">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2" />
                        <path d="m22 7-10 5L2 7" />
                    </svg>
                    Email
                </button>
                <button class="vector-btn" data-vector="sms">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                    SMS
                </button>
                <button class="vector-btn" data-vector="web">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <path
                            d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                    </svg>
                    Web
                </button>
                <button class="vector-btn" data-vector="network">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path
                            d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z" />
                        <path
                            d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z" />
                    </svg>
                    Network
                </button>
            </div>

            <div class="section-label">Display Mode</div>
            <div class="display-modes">
                <div class="mode-option active" data-mode="heatmap">
                    <input type="radio" name="displayMode" value="heatmap" checked>
                    <div class="mode-radio"></div>
                    <div class="mode-info">
                        <div class="mode-title">Heatmap</div>
                        <div class="mode-desc">Density visualization</div>
                    </div>
                    <div class="mode-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" />
                            <rect x="14" y="3" width="7" height="7" />
                            <rect x="14" y="14" width="7" height="7" />
                            <rect x="3" y="14" width="7" height="7" />
                        </svg>
                    </div>
                </div>
                <div class="mode-option" data-mode="cluster">
                    <input type="radio" name="displayMode" value="cluster">
                    <div class="mode-radio"></div>
                    <div class="mode-info">
                        <div class="mode-title">Cluster Points</div>
                        <div class="mode-desc">Individual incidents</div>
                    </div>
                    <div class="mode-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3" />
                            <circle cx="19" cy="5" r="2" />
                            <circle cx="5" cy="19" r="2" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="legend-box">
                <div class="legend-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 2 7 12 12 22 7 12 2" />
                        <polyline points="2 17 12 22 22 17" />
                        <polyline points="2 12 12 17 22 12" />
                    </svg>
                    <span>LEGEND</span>
                </div>
                <div class="section-label" style="margin-top: 0;">Threat Severity</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-dot critical"></div>
                        <span>Critical / Malicious</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot suspicious"></div>
                        <span>Suspicious</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot safe"></div>
                        <span>Monitoring / Safe</span>
                    </div>
                </div>
                <div class="map-indicators">
                    <div class="section-label">Map Indicators</div>
                    <div class="indicator-item">
                        <div class="indicator-dot"></div>
                        <span>Live Incident</span>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-line"></div>
                        <span>Attack Vector</span>
                    </div>
                    <div class="indicator-item">
                        <div class="indicator-gradient"></div>
                        <span>Activity Heatmap</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map Container -->
        <div class="map-container">
            <div id="threat-map"></div>

            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">+</button>
                <button class="zoom-btn" id="zoomOut">âˆ’</button>
                <button class="locate-btn" id="resetView">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="12" cy="12" r="3" />
                        <path d="M12 2v3m0 14v3M2 12h3m14 0h3" />
                    </svg>
                </button>
            </div>

            <!-- Bottom Controls -->
            <div class="bottom-controls">
                <button class="control-btn" id="skipBack">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="19 20 9 12 19 4 19 20" />
                        <line x1="5" y1="19" x2="5" y2="5" />
                    </svg>
                </button>
                <button class="control-btn" id="playPause">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                </button>
                <div class="timeline-visual" id="timelineVisual"></div>
                <span class="live-badge">LIVE</span>
            </div>
        </div>

        <!-- Right Sidebar -->
        <aside class="right-sidebar">
            <div class="live-feed">
                <div class="feed-header">
                    <div class="feed-title">
                        <div class="feed-dot"></div>
                        <span>Live Threat Feed</span>
                    </div>
                    <span class="feed-badge">REAL-TIME</span>
                </div>
                <div class="feed-items" id="feedItems">
                    <!-- Feed items populated by JS -->
                </div>
            </div>

            <div class="top-regions">
                <div class="regions-header">Top Source Regions</div>
                <div class="region-items" id="regionItems">
                    <!-- Region items populated by JS -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Heat -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        /**
         * THREAT MAP - PhishGuard
         * 
         * GAP 1: API DATA CONTRACTS
         * All API responses must conform to strict schemas defined below.
         * Frontend assumes ONLY these fields exist.
         * 
         * GAP 2: LIVE UPDATE MODEL
         * - Poll live endpoints every 5 seconds
         * - New events appended (max 20 entries)
         * - Old entries expire after 60 seconds
         * - Map markers reuse threat_id to prevent duplication
         * - Animations update position only, not re-create layers
         * 
         * GAP 3: PERFORMANCE GUARDRAILS
         * - Max 100 map markers rendered
         * - Max 50 animated attack vectors
         * - Heatmap disabled when zoom < 3
         * - Animation disabled on inactive browser tab
         * 
         * GAP 4: NAVIGATION AUTHORITY
         * - All navigation uses full-page reloads
         * - State not preserved between pages
         * - Active tab derived from URL path only
         */

        (function () {
            'use strict';

            // ============ CONSTANTS & LIMITS ============
            const CONFIG = {
                POLL_INTERVAL_MS: 5000,
                MAX_FEED_ENTRIES: 20,
                ENTRY_EXPIRY_MS: 60000,
                MAX_MAP_MARKERS: 100,
                MAX_ATTACK_VECTORS: 50,
                HEATMAP_MIN_ZOOM: 3,
                API_BASE: '/api/threats'
            };

            // ============ STATE MANAGEMENT ============
            const state = {
                markers: new Map(), // threat_id -> marker
                attackVectors: new Map(), // threat_id -> polyline
                feedEntries: [], // { id, timestamp, element }
                isTabVisible: true,
                isPaused: false,
                heatmapLayer: null,
                displayMode: 'heatmap',
                activeFilters: {
                    threatTypes: ['malware', 'credential_harvesting'],
                    attackVectors: ['email']
                }
            };

            // ============ API DATA SCHEMAS (GAP 1) ============
            /**
             * /api/threats/map-data schema:
             * {
             *   threat_id: string,
             *   type: "malware" | "credential_harvesting" | "social_engineering",
             *   severity: "critical" | "suspicious" | "safe",
             *   source: { lat: number, lng: number },
             *   target: { lat: number, lng: number },
             *   attack_vector: "email" | "sms" | "web" | "network",
             *   timestamp: ISO-8601 string
             * }
             * 
             * /api/threats/live schema:
             * {
             *   id: string,
             *   label: string,
             *   entity: string,
             *   location: string,
             *   severity: string,
             *   timestamp: ISO-8601 string
             * }
             * 
             * /api/threats/regions schema:
             * {
             *   region: string,
             *   count: number
             * }
             */

            function validateMapData(item) {
                return item &&
                    typeof item.threat_id === 'string' &&
                    typeof item.type === 'string' &&
                    typeof item.severity === 'string' &&
                    item.source && typeof item.source.lat === 'number' &&
                    item.target && typeof item.target.lat === 'number' &&
                    typeof item.attack_vector === 'string' &&
                    typeof item.timestamp === 'string';
            }

            function validateLiveData(item) {
                return item &&
                    typeof item.id === 'string' &&
                    typeof item.label === 'string' &&
                    typeof item.entity === 'string' &&
                    typeof item.location === 'string' &&
                    typeof item.severity === 'string' &&
                    typeof item.timestamp === 'string';
            }

            function validateRegionData(item) {
                return item &&
                    typeof item.region === 'string' &&
                    typeof item.count === 'number';
            }

            // ============ MAP INITIALIZATION ============
            let map;

            function initMap() {
                map = L.map('threat-map', {
                    center: [30, 20],
                    zoom: 2,
                    minZoom: 2,
                    maxZoom: 10,
                    zoomControl: false,
                    attributionControl: false
                });

                // Dark tile layer
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);

                // Initialize heatmap layer
                state.heatmapLayer = L.heatLayer([], {
                    radius: 25,
                    blur: 15,
                    maxZoom: 10,
                    gradient: { 0.4: '#1d4ed8', 0.6: '#3b82f6', 0.8: '#f59e0b', 1: '#ef4444' }
                });

                if (state.displayMode === 'heatmap') {
                    state.heatmapLayer.addTo(map);
                }

                // GAP 3: Disable heatmap when zoom < 3
                map.on('zoomend', function () {
                    if (map.getZoom() < CONFIG.HEATMAP_MIN_ZOOM && state.displayMode === 'heatmap') {
                        map.removeLayer(state.heatmapLayer);
                    } else if (map.getZoom() >= CONFIG.HEATMAP_MIN_ZOOM && state.displayMode === 'heatmap') {
                        state.heatmapLayer.addTo(map);
                    }
                });

                // Zoom controls
                document.getElementById('zoomIn').onclick = () => map.zoomIn();
                document.getElementById('zoomOut').onclick = () => map.zoomOut();
                document.getElementById('resetView').onclick = () => map.setView([30, 20], 2);
            }

            // ============ MARKER MANAGEMENT ============
            function createMarkerIcon(severity) {
                return L.divIcon({
                    className: 'threat-marker',
                    html: `<div class="threat-marker-inner ${severity}"></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });
            }

            function updateMarkers(threats) {
                // GAP 3: Enforce max markers limit
                const limitedThreats = threats.slice(0, CONFIG.MAX_MAP_MARKERS);
                const currentIds = new Set(limitedThreats.map(t => t.threat_id));

                // Remove markers that are no longer present
                for (const [id, marker] of state.markers) {
                    if (!currentIds.has(id)) {
                        map.removeLayer(marker);
                        state.markers.delete(id);
                    }
                }

                // GAP 2: Reuse existing markers, update position only
                for (const threat of limitedThreats) {
                    if (!validateMapData(threat)) continue;

                    if (state.markers.has(threat.threat_id)) {
                        // Update existing marker position
                        state.markers.get(threat.threat_id).setLatLng([threat.source.lat, threat.source.lng]);
                    } else {
                        // Create new marker
                        const marker = L.marker([threat.source.lat, threat.source.lng], {
                            icon: createMarkerIcon(threat.severity)
                        }).addTo(map);

                        marker.bindPopup(`
                        <strong>${threat.type.replace('_', ' ')}</strong><br>
                        Severity: ${threat.severity}<br>
                        Vector: ${threat.attack_vector}
                    `);

                        state.markers.set(threat.threat_id, marker);
                    }
                }

                // Update heatmap data
                if (state.displayMode === 'heatmap') {
                    const heatData = limitedThreats.map(t => [t.source.lat, t.source.lng, 0.5]);
                    state.heatmapLayer.setLatLngs(heatData);
                }
            }

            // ============ ATTACK VECTOR LINES ============
            function updateAttackVectors(threats) {
                // GAP 3: Enforce max attack vectors
                const limitedThreats = threats.slice(0, CONFIG.MAX_ATTACK_VECTORS);
                const currentIds = new Set(limitedThreats.map(t => t.threat_id));

                // Remove old vectors
                for (const [id, line] of state.attackVectors) {
                    if (!currentIds.has(id)) {
                        map.removeLayer(line);
                        state.attackVectors.delete(id);
                    }
                }

                // GAP 3: Skip animation if tab not visible
                if (!state.isTabVisible) return;

                for (const threat of limitedThreats) {
                    if (!validateMapData(threat)) continue;

                    if (!state.attackVectors.has(threat.threat_id)) {
                        const color = threat.severity === 'critical' ? '#ef4444' :
                            threat.severity === 'suspicious' ? '#f59e0b' : '#3b82f6';

                        const line = L.polyline([
                            [threat.source.lat, threat.source.lng],
                            [threat.target.lat, threat.target.lng]
                        ], {
                            color: color,
                            weight: 2,
                            opacity: 0.7,
                            dashArray: '10, 5',
                            className: 'attack-vector-path'
                        }).addTo(map);

                        state.attackVectors.set(threat.threat_id, line);
                    }
                }
            }

            // ============ LIVE FEED MANAGEMENT (GAP 2) ============
            function updateLiveFeed(items) {
                const container = document.getElementById('feedItems');
                const now = Date.now();

                // Remove expired entries
                state.feedEntries = state.feedEntries.filter(entry => {
                    if (now - new Date(entry.timestamp).getTime() > CONFIG.ENTRY_EXPIRY_MS) {
                        if (entry.element && entry.element.parentNode) {
                            entry.element.parentNode.removeChild(entry.element);
                        }
                        return false;
                    }
                    return true;
                });

                // Add new entries (max limit enforced)
                for (const item of items) {
                    if (!validateLiveData(item)) continue;

                    // Check for duplicate
                    if (state.feedEntries.some(e => e.id === item.id)) continue;

                    // Enforce max entries
                    if (state.feedEntries.length >= CONFIG.MAX_FEED_ENTRIES) {
                        const oldest = state.feedEntries.shift();
                        if (oldest.element && oldest.element.parentNode) {
                            oldest.element.parentNode.removeChild(oldest.element);
                        }
                    }

                    const element = createFeedElement(item);
                    container.insertBefore(element, container.firstChild);

                    state.feedEntries.push({
                        id: item.id,
                        timestamp: item.timestamp,
                        element: element
                    });
                }
            }

            function createFeedElement(item) {
                const div = document.createElement('div');
                div.className = `feed-item ${item.severity}`;

                const timeAgo = getTimeAgo(new Date(item.timestamp));

                div.innerHTML = `
                <div class="feed-item-header">
                    <span class="feed-item-type">${item.label}</span>
                    <span class="feed-item-time">${timeAgo}</span>
                </div>
                <div class="feed-item-entity">${item.entity}</div>
                <div class="feed-item-location">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="10" r="3"/>
                        <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/>
                    </svg>
                    ${item.location}
                </div>
            `;

                return div;
            }

            function getTimeAgo(date) {
                const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
                if (seconds < 60) return `${seconds}s ago`;
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes}m ago`;
                return `${Math.floor(minutes / 60)}h ago`;
            }

            // ============ TOP REGIONS ============
            function updateRegions(items) {
                const container = document.getElementById('regionItems');
                container.innerHTML = '';

                const maxCount = Math.max(...items.map(i => i.count), 1);

                for (const item of items) {
                    if (!validateRegionData(item)) continue;

                    const percentage = (item.count / maxCount) * 100;
                    const colorClass = percentage > 66 ? 'critical' : percentage > 33 ? 'warning' : 'info';

                    const div = document.createElement('div');
                    div.className = 'region-item';
                    div.innerHTML = `
                    <div class="region-row">
                        <span class="region-name">${item.region}</span>
                        <span class="region-count">${item.count.toLocaleString()}</span>
                    </div>
                    <div class="region-bar">
                        <div class="region-bar-fill ${colorClass}" style="width: ${percentage}%"></div>
                    </div>
                `;
                    container.appendChild(div);
                }
            }

            // ============ API CALLS ============
            async function fetchMapData() {
                try {
                    const response = await fetch(`${CONFIG.API_BASE}/map-data`);
                    if (!response.ok) return [];
                    const data = await response.json();
                    return Array.isArray(data) ? data : [];
                } catch (e) {
                    console.error('Failed to fetch map data:', e);
                    return [];
                }
            }

            async function fetchLiveData() {
                try {
                    const response = await fetch(`${CONFIG.API_BASE}/live`);
                    if (!response.ok) return [];
                    const data = await response.json();
                    return Array.isArray(data) ? data : [];
                } catch (e) {
                    console.error('Failed to fetch live data:', e);
                    return [];
                }
            }

            async function fetchRegions() {
                try {
                    const response = await fetch(`${CONFIG.API_BASE}/regions`);
                    if (!response.ok) return [];
                    const data = await response.json();
                    return Array.isArray(data) ? data : [];
                } catch (e) {
                    console.error('Failed to fetch regions:', e);
                    return [];
                }
            }

            // ============ POLLING (GAP 2) ============
            let pollInterval;

            async function pollData() {
                if (state.isPaused) return;

                const [mapData, liveData, regions] = await Promise.all([
                    fetchMapData(),
                    fetchLiveData(),
                    fetchRegions()
                ]);

                updateMarkers(mapData);
                updateAttackVectors(mapData);
                updateLiveFeed(liveData);
                updateRegions(regions);
            }

            function startPolling() {
                pollData(); // Initial load
                pollInterval = setInterval(pollData, CONFIG.POLL_INTERVAL_MS);
            }

            function stopPolling() {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            }

            // ============ VISIBILITY API (GAP 3) ============
            document.addEventListener('visibilitychange', function () {
                state.isTabVisible = !document.hidden;

                if (document.hidden) {
                    // Stop animations when tab is hidden
                    stopPolling();
                } else {
                    // Resume when visible
                    startPolling();
                }
            });

            // ============ UI CONTROLS ============
            function initControls() {
                // Display mode toggle
                document.querySelectorAll('.mode-option').forEach(option => {
                    option.addEventListener('click', function () {
                        document.querySelectorAll('.mode-option').forEach(o => o.classList.remove('active'));
                        this.classList.add('active');
                        state.displayMode = this.dataset.mode;

                        if (state.displayMode === 'heatmap' && map.getZoom() >= CONFIG.HEATMAP_MIN_ZOOM) {
                            state.heatmapLayer.addTo(map);
                        } else {
                            map.removeLayer(state.heatmapLayer);
                        }
                    });
                });

                // Attack vector buttons
                document.querySelectorAll('.vector-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        this.classList.toggle('active');
                        const vector = this.dataset.vector;
                        const idx = state.activeFilters.attackVectors.indexOf(vector);
                        if (idx > -1) {
                            state.activeFilters.attackVectors.splice(idx, 1);
                        } else {
                            state.activeFilters.attackVectors.push(vector);
                        }
                    });
                });

                // Play/Pause
                document.getElementById('playPause').addEventListener('click', function () {
                    state.isPaused = !state.isPaused;
                    this.innerHTML = state.isPaused ?
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>' :
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
                });

                // Reset filters
                document.getElementById('resetFilters').addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelectorAll('.threat-types input').forEach(cb => cb.checked = false);
                    state.activeFilters.threatTypes = [];
                });

                // Timeline visualization
                initTimeline();
            }

            function initTimeline() {
                const container = document.getElementById('timelineVisual');
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'timeline-bar';
                    bar.style.height = `${Math.random() * 20 + 4}px`;
                    container.appendChild(bar);
                }

                // Animate timeline
                setInterval(() => {
                    if (state.isTabVisible && !state.isPaused) {
                        container.querySelectorAll('.timeline-bar').forEach(bar => {
                            bar.style.height = `${Math.random() * 20 + 4}px`;
                        });
                    }
                }, 500);
            }

            // ============ INITIALIZATION ============
            document.addEventListener('DOMContentLoaded', function () {
                initMap();
                initControls();
                startPolling();
            });

        })();
    </script>
</body>

</html>